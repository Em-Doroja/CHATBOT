<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RBCCI AI Banking Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --green: #1a7a3c;
    --green-dark: #125a2c;
    --green-mid: #22963f;
    --green-light: #d4edda;
    --green-pale: #f0faf3;
    --white: #ffffff;
    --bg: #f6fbf7;
    --border: #c8e6d0;
    --text: #1a2e1f;
    --muted: #5a7a62;
    --shadow: 0 1px 8px rgba(26,122,60,0.08);
    --shadow-lg: 0 4px 24px rgba(26,122,60,0.13);
  }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    width: 100%;
    background: var(--green);
    color: white;
    position: sticky;
    top: 0;
    z-index: 20;
    box-shadow: var(--shadow-lg);
  }

  .header-inner {
    max-width: 760px;
    margin: 0 auto;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .bank-logo-img {
    width: 46px; height: 46px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(255,255,255,0.6);
    flex-shrink: 0;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  .bank-info { flex: 1; }
  .bank-name { font-size: 13.5px; font-weight: 700; line-height: 1.25; letter-spacing: -0.01em; }
  .bank-sub { font-size: 10px; color: rgba(255,255,255,0.72); margin-top: 1px; letter-spacing: 0.04em; }

  .header-right { display: flex; align-items: center; gap: 8px; }

  .lang-badge {
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.22);
    color: white;
    font-size: 10.5px;
    padding: 4px 10px;
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.2s;
    display: flex; align-items: center; gap: 5px;
  }
  .lang-badge:hover { background: rgba(255,255,255,0.22); }

  .online-pill {
    display: flex; align-items: center; gap: 5px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 10px;
    color: rgba(255,255,255,0.85);
  }
  .online-dot { width: 6px; height: 6px; border-radius: 50%; background: #5ef09a; animation: blink 2s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.35} }

  .accent-line { height: 2px; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 40%, rgba(255,255,255,0.4) 60%, rgba(255,255,255,0) 100%); }

  /* ‚îÄ‚îÄ LANGUAGE OVERLAY ‚îÄ‚îÄ */
  #lang-overlay {
    position: fixed; inset: 0;
    background: rgba(10,30,15,0.7);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
  }

  .lang-card {
    background: white;
    border-radius: 20px;
    padding: 34px 28px;
    max-width: 400px;
    width: 100%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    animation: popIn 0.35s cubic-bezier(0.34,1.56,0.64,1);
  }
  @keyframes popIn { from{opacity:0;transform:scale(0.88)} to{opacity:1;transform:scale(1)} }

  .lang-card-logo { margin-bottom: 12px; }
  .lang-card-logo img { width: 72px; height: 72px; border-radius: 50%; object-fit: cover; border: 3px solid var(--green-light); }
  .lang-card-title { font-size: 18px; font-weight: 700; color: var(--green); margin-bottom: 5px; }
  .lang-card-sub { font-size: 12px; color: var(--muted); line-height: 1.75; margin-bottom: 22px; }

  .lang-options { display: flex; flex-direction: column; gap: 9px; }

  .lang-option {
    display: flex; align-items: center; gap: 13px;
    padding: 13px 16px;
    border: 1.5px solid var(--border);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    background: var(--green-pale);
  }
  .lang-option:hover { border-color: var(--green-mid); background: var(--green-light); }
  .lang-option.selected { border-color: var(--green); background: var(--green-light); }

  .lang-option-flag { font-size: 24px; flex-shrink: 0; }
  .lang-option-name { font-size: 13.5px; font-weight: 600; color: var(--green-dark); }
  .lang-option-desc { font-size: 11px; color: var(--muted); margin-top: 1px; }

  .lang-confirm-btn {
    margin-top: 16px;
    width: 100%;
    padding: 12px;
    background: var(--green);
    color: white;
    border: none;
    border-radius: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 13.5px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  .lang-confirm-btn:hover { background: var(--green-dark); }
  .lang-confirm-btn:disabled { background: #c0cfc4; cursor: not-allowed; }

  /* ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ */
  #chat-wrapper {
    width: 100%; max-width: 760px;
    flex: 1; display: flex; flex-direction: column;
  }

  #chat {
    flex: 1;
    padding: 20px 20px 12px;
    display: flex; flex-direction: column; gap: 14px;
    overflow-y: auto; scroll-behavior: smooth;
    max-height: calc(100vh - 260px);
    min-height: 200px;
  }
  #chat::-webkit-scrollbar { width: 4px; }
  #chat::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Welcome */
  .welcome-card {
    background: linear-gradient(135deg, var(--green) 0%, var(--green-mid) 100%);
    color: white; border-radius: 16px;
    padding: 20px 22px;
    box-shadow: var(--shadow-lg);
  }
  .welcome-title { font-size: 15.5px; font-weight: 700; margin-bottom: 6px; }
  .welcome-text { font-size: 13px; line-height: 1.7; color: rgba(255,255,255,0.88); }

  /* Messages */
  .msg { display: flex; gap: 9px; animation: slideIn 0.22s ease; }
  @keyframes slideIn { from{opacity:0;transform:translateY(7px)} to{opacity:1;transform:translateY(0)} }
  .msg.user { flex-direction: row-reverse; }

  .msg-avatar {
    width: 30px; height: 30px; border-radius: 50%;
    flex-shrink: 0; display: flex; align-items: center; justify-content: center;
    margin-top: 2px; overflow: hidden;
  }
  .msg.ai .msg-avatar { background: white; border: 1.5px solid var(--border); }
  .msg.ai .msg-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
  .msg.user .msg-avatar { background: var(--green-mid); color: white; font-size: 10px; font-weight: 700; }

  .msg-content { flex: 1; max-width: 78%; }
  .msg-name { font-size: 9.5px; color: var(--muted); font-weight: 600; letter-spacing: 0.06em; margin-bottom: 3px; text-transform: uppercase; }
  .msg.user .msg-name { text-align: right; }

  .msg-bubble {
    padding: 11px 14px; border-radius: 14px;
    font-size: 13.5px; line-height: 1.75;
    box-shadow: var(--shadow);
  }
  .msg.ai .msg-bubble { background: white; color: var(--text); border-radius: 3px 14px 14px 14px; border: 1px solid var(--border); }
  .msg.ai .msg-bubble.speaking { border-color: var(--green-mid); box-shadow: 0 0 0 2px rgba(34,150,63,0.18); }
  .msg.user .msg-bubble { background: var(--green); color: white; border-radius: 14px 3px 14px 14px; }

  /* Typing */
  .typing-dots { display: flex; gap: 4px; padding: 12px 15px; background: white; border: 1px solid var(--border); border-radius: 3px 14px 14px 14px; width: fit-content; }
  .typing-dots span { width: 6px; height: 6px; border-radius: 50%; background: var(--muted); animation: bounce 1.2s infinite; }
  .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce { 0%,80%,100%{transform:translateY(0);opacity:0.4} 40%{transform:translateY(-5px);opacity:1} }

  /* ‚îÄ‚îÄ FAQ DROPDOWN ‚îÄ‚îÄ */
  .faq-dropdown-wrapper { margin-bottom: 9px; }

  .faq-toggle {
    display: flex; align-items: center; gap: 10px;
    width: 100%; padding: 10px 14px;
    background: linear-gradient(135deg, var(--green) 0%, var(--green-mid) 100%);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.22s;
    font-family: 'Inter', sans-serif;
    font-size: 12.5px; font-weight: 600;
    color: white;
    text-align: left;
    box-shadow: 0 2px 10px rgba(26,122,60,0.22);
  }
  .faq-toggle:hover { filter: brightness(1.08); box-shadow: 0 4px 16px rgba(26,122,60,0.3); transform: translateY(-1px); }
  .faq-toggle.open { border-radius: 12px 12px 0 0; transform: none; box-shadow: 0 2px 10px rgba(26,122,60,0.22); }

  .faq-toggle-icon { font-size: 16px; flex-shrink: 0; }
  .faq-toggle-label { flex: 1; }
  .faq-toggle-count {
    background: rgba(255,255,255,0.2);
    border-radius: 20px;
    font-size: 10px; font-weight: 700;
    padding: 2px 8px;
    color: rgba(255,255,255,0.95);
    letter-spacing: 0.03em;
  }
  .faq-chevron {
    font-size: 11px;
    transition: transform 0.28s cubic-bezier(0.34,1.56,0.64,1);
    color: rgba(255,255,255,0.85);
    flex-shrink: 0;
  }
  .faq-toggle.open .faq-chevron { transform: rotate(180deg); }

  /* Animated panel */
  .faq-panel-outer {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.32s cubic-bezier(0.4,0,0.2,1);
    background: white;
    border: 1.5px solid var(--green);
    border-top: none;
    border-radius: 0 0 12px 12px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(26,122,60,0.1);
  }
  .faq-panel-outer.open { grid-template-rows: 1fr; }
  .faq-panel-inner { overflow: hidden; }

  .faq-panel {
    padding: 14px 12px 12px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }

  @media (max-width: 480px) {
    .faq-panel { grid-template-columns: repeat(2, 1fr); }
  }

  .faq-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: var(--green-pale);
    border: 1.5px solid var(--border);
    color: var(--green-dark);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    padding: 12px 8px 10px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.18s;
    text-align: center;
    line-height: 1.3;
    min-height: 68px;
  }
  .faq-btn:hover {
    border-color: var(--green-mid);
    background: var(--green-light);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(26,122,60,0.15);
    color: var(--green-dark);
  }
  .faq-btn:active { transform: translateY(0); }
  .faq-btn-icon { font-size: 22px; line-height: 1; }
  .faq-btn-label { font-size: 10.5px; font-weight: 600; color: var(--green-dark); }

  /* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
  #controls {
    background: white;
    border-top: 1px solid var(--border);
    padding: 11px 20px 15px;
    width: 100%; max-width: 760px;
    box-shadow: 0 -3px 16px rgba(26,122,60,0.05);
  }

  #live-row { display: flex; align-items: center; gap: 7px; min-height: 18px; margin-bottom: 7px; }
  #status-indicator { width: 6px; height: 6px; border-radius: 50%; background: #c5d9c9; flex-shrink: 0; transition: background 0.3s; }
  #status-indicator.listening { background: #22c55e; animation: pulse 1s infinite; }
  #status-indicator.speaking { background: var(--green-mid); animation: pulse 1s infinite; }
  #status-indicator.thinking { background: #60a5fa; animation: pulse 0.6s infinite; }
  @keyframes pulse { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.6);opacity:0.5} }
  #status-text { font-size: 10.5px; color: var(--muted); flex: 1; font-style: italic; }
  #live-transcript { font-size: 10.5px; color: var(--green); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

  .input-row { display: flex; gap: 7px; align-items: flex-end; }

  #text-input {
    flex: 1;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    font-family: 'Inter', sans-serif;
    font-size: 13.5px; color: var(--text); background: var(--bg);
    resize: none; outline: none; line-height: 1.5;
    transition: border-color 0.2s;
    min-height: 42px; max-height: 100px;
  }
  #text-input:focus { border-color: var(--green-mid); }
  #text-input::placeholder { color: #9ab5a0; }

  .icon-btn {
    width: 42px; height: 42px; border-radius: 10px;
    border: 1.5px solid var(--border); background: var(--bg);
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 17px; transition: all 0.2s; flex-shrink: 0;
  }
  .icon-btn:hover { border-color: var(--green-mid); background: var(--green-pale); }
  #mic-btn.listening { background: var(--green); border-color: var(--green); box-shadow: 0 0 0 3px rgba(26,122,60,0.2); }
  #send-btn { background: var(--green); border-color: var(--green); color: white; font-size: 16px; }
  #send-btn:hover { background: var(--green-dark); }

  .footer-note { text-align: center; font-size: 9.5px; color: var(--muted); margin-top: 9px; line-height: 1.7; }
  .footer-note a { color: var(--green-mid); text-decoration: none; }

  #no-support { display: none; background: #fffbea; border: 1px solid #f0d060; color: #7a6000; border-radius: 8px; padding: 8px 12px; font-size: 11px; margin-bottom: 8px; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="header-inner">
    <img class="bank-logo-img" src="logo.jpg" alt="RBCCI Logo">
    <div class="bank-info">
      <div class="bank-name">Rural Bank of Calbayog City, Inc.</div>
      <div class="bank-sub">RBCCI ¬∑ Since 1959 ¬∑ Together We Grow</div>
    </div>
    <div class="header-right">
      <div class="lang-badge" onclick="resetLanguage()" title="Change language">
        <span id="header-flag">üåê</span>
        <span id="header-lang">Language</span>
      </div>
      <div class="online-pill">
        <div class="online-dot"></div>
        Online
      </div>
    </div>
  </div>
  <div class="accent-line"></div>
</header>

<!-- LANGUAGE OVERLAY -->
<div id="lang-overlay">
  <div class="lang-card">
    <div class="lang-card-logo">
      <img src="logo.jpg" alt="RBCCI Logo">
    </div>
    <div class="lang-card-title">RBCCI AI Banking Assistant</div>
    <div class="lang-card-sub">
      Welcome! Please choose your preferred language.<br>
      Maligayang pagdating! Piliin ang inyong wika.<br>
      Maupay nga pag-abot! Pilia an imo pinaka-gusto nga yinaknan.
    </div>
    <div class="lang-options">
      <div class="lang-option" id="opt-en" onclick="selectLang('en')">
        <div class="lang-option-flag">üá∫üá∏</div>
        <div class="lang-option-info">
          <div class="lang-option-name">English</div>
          <div class="lang-option-desc">Continue in English</div>
        </div>
      </div>
      <div class="lang-option" id="opt-tl" onclick="selectLang('tl')">
        <div class="lang-option-flag">üáµüá≠</div>
        <div class="lang-option-info">
          <div class="lang-option-name">Filipino / Tagalog</div>
          <div class="lang-option-desc">Magpatuloy sa Filipino</div>
        </div>
      </div>
      <div class="lang-option" id="opt-war" onclick="selectLang('war')">
        <div class="lang-option-flag">üå∫</div>
        <div class="lang-option-info">
          <div class="lang-option-name">Waray-Waray</div>
          <div class="lang-option-desc">Padayon ha Waray-Waray</div>
        </div>
      </div>
    </div>
    <button class="lang-confirm-btn" id="confirm-lang-btn" onclick="confirmLanguage()" disabled>
      Continue / Magpatuloy / Padayon
    </button>
  </div>
</div>

<!-- CHAT -->
<div id="chat-wrapper">
  <div id="chat"></div>

  <div id="controls">
    <div id="no-support">‚ö† Voice input works best on Chrome or Edge. You can still type below.</div>
    <div id="live-row">
      <div id="status-indicator"></div>
      <div id="status-text">Ready</div>
      <div id="live-transcript"></div>
    </div>
    <div id="faq-area" class="faq-dropdown-wrapper"></div>
    <div class="input-row">
      <textarea id="text-input" placeholder="Type your question..." rows="1"
        onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button class="icon-btn" id="mic-btn" onclick="toggleMic()" title="Voice input">üéô</button>
      <button class="icon-btn" id="send-btn" onclick="sendText()" title="Send">‚û§</button>
    </div>
    <div class="footer-note">
      Regulated by <a href="https://www.bsp.gov.ph" target="_blank">Bangko Sentral ng Pilipinas</a> &nbsp;¬∑&nbsp;
      Deposits insured by PDIC up to ‚Ç±1 million &nbsp;¬∑&nbsp;
      üìû 0965-308-7958
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let selectedLang = null, history = [], recognition = null, isListening = false, speakingBubble = null;

// ‚îÄ‚îÄ LOGO (base64) ‚îÄ‚îÄ
const LOGO_B64 = 'logo.jpg';


// ‚îÄ‚îÄ LANGUAGE CONFIG ‚îÄ‚îÄ
const LANG = {
  en: {
    flag: 'üá∫üá∏', label: 'English', speechLang: 'en-PH',
    placeholder: 'Type your question here...',
    statusReady: 'Ready to assist you',
    statusListening: 'Listening...',
    statusThinking: 'Processing your inquiry...',
    statusSpeaking: 'Speaking response...',
    assistantName: 'RBCCI Assistant', youLabel: 'You',
    welcomeTitle: 'üëã Welcome to RBCCI!',
    welcomeText: "I'm your AI Banking Assistant for Rural Bank of Calbayog City, Inc. Ask me anything about our loans, deposits, services, or contact details. Type or use the microphone!",
    faqLabel: 'üí¨ Frequently Asked Questions',
    faqs: [
      { icon: 'üí∞', label: 'Loan Products', q: 'What loan products does RBCCI offer?' },
      { icon: 'üè¶', label: 'Open an Account', q: 'How do I open a savings account?' },
      { icon: 'üïê', label: 'Banking Hours', q: 'What are your banking hours?' },
      { icon: 'üìû', label: 'Contact Info', q: 'How can I contact RBCCI?' },
      { icon: 'üîí', label: 'Deposit Insurance', q: 'Are my deposits insured?' },
      { icon: 'üìã', label: 'Loan Requirements', q: 'What are the requirements for a loan?' },
      { icon: 'üåæ', label: 'Agricultural Loan', q: 'Tell me about agricultural loans.' },
      { icon: 'üè†', label: 'Housing Loan', q: 'What is a housing or real estate loan?' },
      { icon: 'üè¢', label: 'SME Loan', q: 'What is a micro or SME business loan?' },
      { icon: 'üí≥', label: 'ATM / Debit Card', q: 'Do you offer ATM or debit card services?' },
      { icon: 'üìç', label: 'Location', q: 'Where is RBCCI located?' },
      { icon: 'üßæ', label: 'Bill Payment', q: 'Can I pay my electric bill at RBCCI?' },
    ]
  },
  tl: {
    flag: 'üáµüá≠', label: 'Filipino', speechLang: 'fil-PH',
    placeholder: 'I-type ang iyong tanong dito...',
    statusReady: 'Handa na akong tumulong sa inyo',
    statusListening: 'Nakikinig...',
    statusThinking: 'Pinoproseso ang inyong katanungan...',
    statusSpeaking: 'Nagsasalita...',
    assistantName: 'RBCCI Katulong', youLabel: 'Ikaw',
    welcomeTitle: 'üëã Maligayang pagdating sa RBCCI!',
    welcomeText: 'Ako ang inyong AI Banking Assistant ng Rural Bank of Calbayog City, Inc. Maaari kayong magtanong tungkol sa aming mga pautang, deposito, serbisyo, at iba pa. I-type o gamitin ang mikropono!',
    faqLabel: 'üí¨ Mga Madalas na Katanungan (FAQ)',
    faqs: [
      { icon: 'üí∞', label: 'Mga Produktong Pautang', q: 'Anong mga pautang ang inaalok ng RBCCI?' },
      { icon: 'üè¶', label: 'Mag-open ng Account', q: 'Paano mag-open ng savings account?' },
      { icon: 'üïê', label: 'Oras ng Bangko', q: 'Ano ang oras ng pag-ooperate ng bangko?' },
      { icon: 'üìû', label: 'Makipag-ugnayan', q: 'Paano makipag-ugnayan sa RBCCI?' },
      { icon: 'üîí', label: 'Seguro ng Deposito', q: 'Naka-insure ba ang aking deposito?' },
      { icon: 'üìã', label: 'Mga Kinakailangan', q: 'Ano ang mga kinakailangan para sa pautang?' },
      { icon: 'üåæ', label: 'Agricultural na Pautang', q: 'Sabihin sa akin ang tungkol sa agricultural na pautang.' },
      { icon: 'üè†', label: 'Housing Loan', q: 'Ano ang housing o real estate loan?' },
      { icon: 'üè¢', label: 'SME na Pautang', q: 'Ano ang micro o SME business loan?' },
      { icon: 'üí≥', label: 'ATM / Debit Card', q: 'Mayroon ba kayong ATM o debit card na serbisyo?' },
      { icon: 'üìç', label: 'Lokasyon', q: 'Saan matatagpuan ang RBCCI?' },
      { icon: 'üßæ', label: 'Bayad ng Kuryente', q: 'Maaari ko bang bayaran ang aking kuryente sa RBCCI?' },
    ]
  },
  war: {
    flag: 'üå∫', label: 'Waray-Waray', speechLang: 'fil-PH',
    placeholder: 'I-type dinhi an imo pangutana...',
    statusReady: 'Andam na ak nga tabangan kamo',
    statusListening: 'Nagpapamati...',
    statusThinking: 'Ginpoproseso an imo pangutana...',
    statusSpeaking: 'Nagsasalita...',
    assistantName: 'RBCCI Katig-uban', youLabel: 'Ikaw',
    welcomeTitle: 'üëã Maupay nga pag-abot ha RBCCI!',
    welcomeText: 'Ako an imo AI Banking Assistant han Rural Bank of Calbayog City, Inc. Himo hin pangutana mahitungod han amon mga utang, deposito, serbisyo, ug uban pa. Puwede ka magsulat o gamiton an mikropono!',
    faqLabel: 'üí¨ Mga Nasambit nga Pangutana (FAQ)',
    faqs: [
      { icon: 'üí∞', label: 'Mga Produkto han Utang', q: 'Ano nga mga utang an ginaalok han RBCCI?' },
      { icon: 'üè¶', label: 'Bukha hin Account', q: 'Pano mag-bukha hin savings account?' },
      { icon: 'üïê', label: 'Oras han Bangko', q: 'Ano an oras han operasyon han bangko?' },
      { icon: 'üìû', label: 'Makipag-ugnayan', q: 'Pano makipag-ugnayan ha RBCCI?' },
      { icon: 'üîí', label: 'Seguro han Deposito', q: 'Naka-insure ba an akon deposito?' },
      { icon: 'üìã', label: 'Mga Kinahanglan', q: 'Ano an mga kinahanglan para ha utang?' },
      { icon: 'üåæ', label: 'Utang para ha Agrikultura', q: 'Isumat ha akon an mahitungod han agricultural na utang.' },
      { icon: 'üè†', label: 'Housing Loan', q: 'Ano an housing o real estate loan?' },
      { icon: 'üè¢', label: 'SME nga Utang', q: 'Ano an micro o SME business loan?' },
      { icon: 'üí≥', label: 'ATM / Debit Card', q: 'Mayroon ba kamo hin ATM o debit card nga serbisyo?' },
      { icon: 'üìç', label: 'Lokasyon', q: 'Hain an RBCCI?' },
      { icon: 'üßæ', label: 'Bayad han Kuryente', q: 'Puwede ko ba bayaran an akon kuryente ha RBCCI?' },
    ]
  }
};

// ‚îÄ‚îÄ SYSTEM PROMPT ‚îÄ‚îÄ
function buildSystemPrompt(lang) {
  const li = {
    en: 'Always respond in ENGLISH only, regardless of what language the user writes in.',
    tl: 'Palaging sumagot sa FILIPINO/TAGALOG lamang, kahit anong wika ang gamitin ng user. Gamitin ang magalang na Filipino.',
    war: 'Permi sungbatan ha WARAY-WARAY la, bisan ano nga yinaknan an gamiton han user. Gamiton an maayos ug galang nga Waray-Waray. Kung diri mo aram an eksaktong salita, gamiton in Tagalog o English nga salita nga kasagaran naggagamit an mga taga-Samar.'
  };
  return `You are the official AI Banking Assistant for Rural Bank of Calbayog City, Inc. (RBCCI).

LANGUAGE RULE (CRITICAL): ${li[lang]}

ABOUT RBCCI:
- Full name: Rural Bank of Calbayog City, Incorporated (RBCCI)
- Founded: February 7, 1959 by the late Hermenegildo R. Rosales
- First bank in the City of Calbayog and Province of Samar
- Motto: "Together We Grow"
- Regulated by Bangko Sentral ng Pilipinas (BSP)
- Deposits insured by PDIC up to ‚Ç±1 million per depositor

LOCATION & CONTACT:
- Head Office: 82 T. Bugallon St., Brgy. Central, Calbayog City, Samar 6710
- Phone: 0965-308-7958 / (055) 209-1265 / (055) 209-1407
- Email: rbcci@rbcalbayogcity.com
- Website: rbcalbayog.com
- Banking Hours: Monday‚ÄìFriday, 8:30 AM ‚Äì 4:00 PM
- Office Hours: Monday‚ÄìFriday, 8:00 AM ‚Äì 5:00 PM

LOAN PRODUCTS:
1. Personal/Salary Loan ‚Äî Up to ‚Ç±200,000. For employed individuals with min net take-home pay ‚Ç±7,500. Max age: 60 at last amortization.
2. Agricultural Loan ‚Äî For farmers, fisherfolk, agrarian reform beneficiaries. Supported via Agricultural Credit Policy Council.
3. Micro/SME Business Loan ‚Äî Up to ‚Ç±150,000 unsecured; up to ‚Ç±300,000 secured. Term: 5 years (unsecured) or 15 years (secured). Business must be operating at least 1 year.
4. Housing/Real Estate Loan ‚Äî Up to ‚Ç±200,000 unsecured; secured up to 60% of appraised value. Term: up to 15 years secured.
5. Other Loans ‚Äî For needs not covered by standard categories.

LOAN REQUIREMENTS: Valid ID, proof of income. Salary loan: certificate of employment. Business loan: business permit, financial statements. Housing loan: land title or property documents. Visit branch for complete requirements.

DEPOSIT ACCOUNTS:
- Individual Savings: Min initial deposit ‚Ç±1,000; earns interest at ‚Ç±3,000 balance
- Junior/Minor Savings: Min ‚Ç±100; earns interest at ‚Ç±500 balance
- Association/Organization: Min ‚Ç±3,000; earns interest at ‚Ç±10,000 balance
- Time Deposit: Min initial deposit ‚Ç±5,000
- ATM/debit card via BancNet

OTHER SERVICES: Electric bill payment (‚Ç±5 service fee), BancNet ATM, Philippine Digital National ID, OFW banking services for Samare√±os abroad.

RESPONSE GUIDELINES:
- Keep responses concise and conversational (1‚Äì4 sentences for simple queries).
- This assistant speaks aloud, so avoid bullet points and markdown ‚Äî use plain sentences.
- Be warm, professional, and helpful.
- For specific rates, application status, or account queries, direct to branch or contact number.
- Never invent specific interest rates.
- For complaints: 0965-308-7958 or rbcci@rbcalbayogcity.com`;
}

// ‚îÄ‚îÄ LANG SELECTION ‚îÄ‚îÄ
function selectLang(lang) {
  selectedLang = lang;
  document.querySelectorAll('.lang-option').forEach(el => el.classList.remove('selected'));
  document.getElementById('opt-' + lang).classList.add('selected');
  document.getElementById('confirm-lang-btn').disabled = false;
}

function confirmLanguage() {
  if (!selectedLang) return;
  document.getElementById('lang-overlay').style.display = 'none';
  applyLanguage(selectedLang);
  showWelcome();
  buildFAQs();
}

function resetLanguage() {
  selectedLang = null; history = [];
  document.getElementById('chat').innerHTML = '';
  document.getElementById('lang-overlay').style.display = 'flex';
  document.querySelectorAll('.lang-option').forEach(el => el.classList.remove('selected'));
  document.getElementById('confirm-lang-btn').disabled = true;
  document.getElementById('faq-area').innerHTML = '';
  stopSpeaking();
  setStatus('', LANG.en.statusReady);
}

function applyLanguage(lang) {
  const cfg = LANG[lang];
  document.getElementById('header-flag').textContent = cfg.flag;
  document.getElementById('header-lang').textContent = cfg.label;
  document.getElementById('text-input').placeholder = cfg.placeholder;
  setStatus('', cfg.statusReady);
}

// ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ
function showWelcome() {
  const cfg = LANG[selectedLang];
  const chatEl = document.getElementById('chat');
  chatEl.innerHTML = '';
  const card = document.createElement('div');
  card.className = 'welcome-card';
  card.innerHTML = `<div class="welcome-title">${cfg.welcomeTitle}</div><div class="welcome-text">${cfg.welcomeText}</div>`;
  chatEl.appendChild(card);
}

// ‚îÄ‚îÄ FAQ DROPDOWN ‚îÄ‚îÄ
function buildFAQs() {
  const cfg = LANG[selectedLang];
  const area = document.getElementById('faq-area');
  area.innerHTML = '';

  const wrapper = document.createElement('div');
  wrapper.className = 'faq-dropdown-wrapper';

  const toggle = document.createElement('button');
  toggle.className = 'faq-toggle';
  toggle.innerHTML = `
    <span class="faq-toggle-icon">üí¨</span>
    <span class="faq-toggle-label">${cfg.faqLabel}</span>
    <span class="faq-toggle-count">${cfg.faqs.length}</span>
    <span class="faq-chevron">‚ñº</span>
  `;

  const panelOuter = document.createElement('div');
  panelOuter.className = 'faq-panel-outer';

  const panelInner = document.createElement('div');
  panelInner.className = 'faq-panel-inner';

  const panel = document.createElement('div');
  panel.className = 'faq-panel';

  toggle.onclick = () => {
    const isOpen = toggle.classList.toggle('open');
    panelOuter.classList.toggle('open', isOpen);
  };

  cfg.faqs.forEach((faq, i) => {
    const btn = document.createElement('button');
    btn.className = 'faq-btn';
    btn.innerHTML = `<span class="faq-btn-icon">${faq.icon}</span><span class="faq-btn-label">${faq.label}</span>`;
    btn.style.animationDelay = `${i * 30}ms`;
    btn.onclick = () => {
      stopSpeaking();
      toggle.classList.remove('open');
      panelOuter.classList.remove('open');
      sendMessage(faq.q);
    };
    panel.appendChild(btn);
  });

  panelInner.appendChild(panel);
  panelOuter.appendChild(panelInner);
  wrapper.appendChild(toggle);
  wrapper.appendChild(panelOuter);
  area.appendChild(wrapper);
}

// ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ
function setStatus(type, text) {
  document.getElementById('status-indicator').className = type || '';
  document.getElementById('status-text').textContent = text;
}

// ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ
function addMessage(role, text) {
  const chatEl = document.getElementById('chat');
  const cfg = LANG[selectedLang] || LANG.en;
  const msg = document.createElement('div');
  msg.className = `msg ${role}`;

  const avatar = document.createElement('div');
  avatar.className = 'msg-avatar';
  if (role === 'ai') {
    const img = document.createElement('img');
    img.src = LOGO_B64;
    img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%';
    avatar.appendChild(img);
  } else {
    avatar.textContent = cfg.youLabel.substring(0,3).toUpperCase();
  }

  const content = document.createElement('div');
  content.className = 'msg-content';

  const name = document.createElement('div');
  name.className = 'msg-name';
  name.textContent = role === 'user' ? cfg.youLabel : cfg.assistantName;

  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  bubble.textContent = text;

  content.appendChild(name);
  content.appendChild(bubble);
  msg.appendChild(avatar);
  msg.appendChild(content);
  chatEl.appendChild(msg);
  chatEl.scrollTop = chatEl.scrollHeight;
  return bubble;
}

function addTyping() {
  const chatEl = document.getElementById('chat');
  const msg = document.createElement('div');
  msg.className = 'msg ai'; msg.id = 'typing-msg';
  const avatar = document.createElement('div');
  avatar.className = 'msg-avatar';
  const img = document.createElement('img');
  img.src = LOGO_B64;
  img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%';
  avatar.appendChild(img);
  const content = document.createElement('div');
  content.className = 'msg-content';
  const name = document.createElement('div');
  name.className = 'msg-name';
  name.textContent = (LANG[selectedLang] || LANG.en).assistantName;
  const dots = document.createElement('div');
  dots.className = 'typing-dots';
  dots.innerHTML = '<span></span><span></span><span></span>';
  content.appendChild(name); content.appendChild(dots);
  msg.appendChild(avatar); msg.appendChild(content);
  chatEl.appendChild(msg);
  chatEl.scrollTop = chatEl.scrollHeight;
}
function removeTyping() { const t = document.getElementById('typing-msg'); if (t) t.remove(); }

// ‚îÄ‚îÄ SEND ‚îÄ‚îÄ
async function sendMessage(text) {
  if (!text.trim() || !selectedLang) return;
  const cfg = LANG[selectedLang];
  addMessage('user', text);
  history.push({ role: 'user', content: text });
  setStatus('thinking', cfg.statusThinking);
  addTyping();
  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: 'claude-haiku-4-5-20251001', max_tokens: 1000, system: buildSystemPrompt(selectedLang), messages: history })
    });
    const data = await res.json();
    removeTyping();
    if (data.error) throw new Error(data.error.message);
    const reply = data.content.map(b => b.text || '').join('');
    history.push({ role: 'assistant', content: reply });
    const bubble = addMessage('ai', reply);
    speak(reply, bubble);
  } catch (err) {
    removeTyping();
    const errMsgs = { en: 'Sorry, I encountered a problem. Please try again or call us at 0965-308-7958.', tl: 'Paumanhin, nagkaroon ng problema. Subukang muli o tumawag sa 0965-308-7958.', war: 'Pasensya, adunay naabutan nga problema. Sulayi liwat o tawaga kami ha 0965-308-7958.' };
    addMessage('ai', errMsgs[selectedLang] || errMsgs.en);
    setStatus('', cfg.statusReady);
  }
}

// ‚îÄ‚îÄ TTS ‚îÄ‚îÄ
function speak(text, bubble) {
  if (!window.speechSynthesis) { setStatus('', LANG[selectedLang].statusReady); return; }
  window.speechSynthesis.cancel();
  const cfg = LANG[selectedLang];
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = cfg.speechLang; utter.rate = 1.0; utter.pitch = 1;
  const voices = window.speechSynthesis.getVoices();
  let preferred = null;
  if (selectedLang === 'en') {
    preferred = voices.find(v => v.lang === 'en-PH') || voices.find(v => v.name.includes('Samantha')) || voices.find(v => v.name.includes('Google US English')) || voices.find(v => v.lang.startsWith('en'));
  } else {
    preferred = voices.find(v => v.lang === 'fil-PH') || voices.find(v => v.lang === 'fil') || voices.find(v => v.lang === 'tl-PH') || voices.find(v => v.lang === 'tl') || voices.find(v => v.name.toLowerCase().includes('filipino')) || voices[0];
  }
  if (preferred) utter.voice = preferred;
  speakingBubble = bubble; bubble.classList.add('speaking'); setStatus('speaking', cfg.statusSpeaking);
  utter.onend = () => { if (speakingBubble) speakingBubble.classList.remove('speaking'); speakingBubble = null; setStatus('', cfg.statusReady); };
  utter.onerror = () => { if (speakingBubble) speakingBubble.classList.remove('speaking'); speakingBubble = null; setStatus('', cfg.statusReady); };
  window.speechSynthesis.speak(utter);
}
function stopSpeaking() { if (window.speechSynthesis) window.speechSynthesis.cancel(); if (speakingBubble) speakingBubble.classList.remove('speaking'); speakingBubble = null; }

// ‚îÄ‚îÄ STT ‚îÄ‚îÄ
function setupRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { document.getElementById('no-support').style.display = 'block'; return false; }
  recognition = new SR();
  recognition.continuous = false; recognition.interimResults = true;
  recognition.lang = LANG[selectedLang]?.speechLang || 'en-PH';
  recognition.onstart = () => { isListening = true; setStatus('listening', LANG[selectedLang].statusListening); document.getElementById('mic-btn').classList.add('listening'); document.getElementById('mic-btn').textContent = '‚èπ'; };
  recognition.onresult = (e) => { let interim='',final=''; for (let i=e.resultIndex;i<e.results.length;i++){const t=e.results[i][0].transcript;if(e.results[i].isFinal)final+=t;else interim+=t;} document.getElementById('live-transcript').textContent=final||interim; if(final)document.getElementById('text-input').value=final; };
  recognition.onend = () => { const t=document.getElementById('text-input').value.trim()||document.getElementById('live-transcript').textContent.trim(); stopListeningUI(); document.getElementById('live-transcript').textContent=''; if(t){document.getElementById('text-input').value='';sendMessage(t);}else{setStatus('',LANG[selectedLang].statusReady);} };
  recognition.onerror = (e) => { stopListeningUI(); document.getElementById('live-transcript').textContent=''; if(e.error!=='no-speech'&&e.error!=='aborted'){setStatus('','Voice error ‚Äî please try again');}else{setStatus('',LANG[selectedLang].statusReady);} };
  return true;
}
function stopListeningUI() { isListening=false; document.getElementById('mic-btn').classList.remove('listening'); document.getElementById('mic-btn').textContent='üéô'; }
function toggleMic() { if(!selectedLang)return; if(isListening){recognition&&recognition.stop();return;} stopSpeaking(); if(!recognition){if(!setupRecognition())return;}else{recognition.lang=LANG[selectedLang].speechLang;} document.getElementById('text-input').value=''; try{recognition.start();}catch(e){} }

// ‚îÄ‚îÄ TEXT INPUT ‚îÄ‚îÄ
function sendText() { const t=document.getElementById('text-input').value.trim(); if(!t||!selectedLang)return; stopSpeaking(); document.getElementById('text-input').value=''; document.getElementById('text-input').style.height='auto'; sendMessage(t); }
function handleKey(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendText();} }
function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,100)+'px'; }

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
if (window.speechSynthesis) { window.speechSynthesis.getVoices(); window.speechSynthesis.onvoiceschanged=()=>window.speechSynthesis.getVoices(); }
if (!window.SpeechRecognition && !window.webkitSpeechRecognition) { document.getElementById('no-support').style.display='block'; }
</script>
</body>
</html>
